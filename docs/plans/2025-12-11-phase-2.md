# Phase 2: Narrative System - Implementation Plan

**Date:** 2025-12-08
**Last Updated:** 2025-12-08
**Status:** Pending
**Scope:** Implement the narrative engine, interactive dialogue with skill checks/logs, the passive Companion system, and Act 1 content.

---

## Overview

This phase builds the non-combat gameplay loop. We will implement a node-based story engine that supports standard narration and complex NPC interactions with skill checks.

1. **Step 1: Core Architecture & Data Schema** - Define types for Nodes, Choices (including Skill Checks), and the Zustand store.
2. **Step 2: Narrative Engine Logic** - Implement logic for requirements, skill check dice rolls, and ephemeral dialogue state.
3. **Step 3: UI Implementation** - Create `StoryScreen`, `DialogueView` (with Log), and `CompanionWidget`.
4. **Step 4: Content Integration** - Implement "The Spire of the Lich King" Act 1.

---

## Step 1: Core Architecture & Data Schema

### Goal
Define data structures to support narrative flow, specifically adding support for Skill Checks (DC/Attribute) and a Conversation Log.

### Implementation Order

#### Step 1.1: Type Definitions
**Prerequisites:** None
*  Create `src/types/narrative.ts`.
*  Update `Choice` to support Skill Checks.

```typescript
export type NodeType = 'NARRATIVE' | 'DIALOGUE' | 'COMBAT' | 'PUZZLE';

export interface SkillCheck {
 attribute: 'STR' | 'DEX' | 'CON' | 'INT' | 'WIS' | 'CHA';
 dc: number;
}

export interface Choice {
 id: string;
 text: string; // e.g. "Lie to the guard"
 nextNodeId: string | null; 
 
 // Requirements to SEE the option
 requirements?: Requirement[]; 
 
 // Skill Check Logic (Visible Dice Roll)
 skillCheck?: SkillCheck;
 onSuccessNodeId?: string; // If passed, go here
 onFailNodeId?: string;  // If failed, go here
 
 // Elder Scrolls Style
 isLoop?: boolean; // Returns to current node (for questions)
}

export interface LogEntry {
 id: string;
 timestamp: number;
 source: 'SYSTEM' | 'PLAYER' | 'NPC';
 text: string;
 rollResult?: {
  total: number;
  die: number;
  modifier: number;
  dc: number;
  success: boolean;
 };
}

export interface StoryNode {
 id: string;
 type: NodeType;
 // ... standard fields (title, description, image) ...
 companionHint?: string; // Passive hint text
 choices: Choice[];
}
```

#### Step 1.2: Narrative Store
**Prerequisites:** Step 1.1
*  Create `src/store/narrativeStore.ts`.
*  **State:**
  *  `currentCampaignId`: string
  *  `currentNodeId`: string
  *  `worldFlags`: Record<string, boolean>
  *  `sessionChoiceIds`: string[] (Tracks clicked options *only* for the current interaction, resets on exit).
  *  `log`: LogEntry[] (The history of the conversation + rolls).
*  **Actions:**
  *  `addLogEntry(entry)`
  *  `resetSessionState()` (Clears `sessionChoiceIds` and `log` when entering a new dialogue).

---

## Step 2: Narrative Engine Logic

### Goal
Implement the mechanics for dice rolls inside dialogue and state management.

### Implementation Order

#### Step 2.1: Skill Check Resolver
**Prerequisites:** Step 1.1, Dice Utils (Phase 1)
*  Create `src/utils/narrativeLogic.ts`.
*  Implement `resolveSkillCheck(player: Player, check: SkillCheck)`.
*  **Logic:**
  1. Roll d20.
  2. Get player attribute modifier.
  3. Compare (Roll + Mod) >= DC.
  4. Return result object (success/fail, raw values).

#### Step 2.2: Choice Handler
**Prerequisites:** Step 2.1
*  Implement `handleChoice` in the store.
*  **Flow:**
  1. If choice has `skillCheck`:
    *  Call `resolveSkillCheck`.
    *  Create `LogEntry` with roll details ("Rolled 15 + 2 (STR) vs DC 12... Success").
    *  Route to `onSuccessNodeId` or `onFailNodeId`.
  2. If no check:
    *  Route to `nextNodeId`.
  3. Add `choice.id` to `sessionChoiceIds` (to gray it out for this session).
  4. If `nextNodeId` is null (exit), call `resetSessionState`.

---

## Step 3: UI Implementation

### Goal
Build the Narrative UI, focusing on the Split View for dialogue (Portrait + Log + Options).

### Implementation Order

#### Step 3.1: Narrative Log Component
**Prerequisites:** Step 1.1
*  Create `src/components/narrative/NarrativeLog.tsx`.
*  **Style:** Similar to the Combat Log (scrollable container, dark background).
*  **Rendering:**
  *  Text entries.
  *  **Roll Results:** Special formatting for dice rolls (e.g., Green text for Success, Red for Fail).
  *  Example: `[Player] Lie to the guard (Rolled 18 vs DC 12 - Success)`

#### Step 3.2: Dialogue View
**Prerequisites:** Step 3.1
*  Create `src/components/narrative/DialogueView.tsx`.
*  **Layout (Portrait Mode):**
  *  **Header:** NPC Portrait + Name.
  *  **Body (Flexible):** `NarrativeLog` (Shows the history of this convo).
  *  **Footer (Fixed):** Choice List.
*  **Choice Rendering:**
  *  If `choice.skillCheck` exists: Render `[Attribute DC XX] Text`.
  *  If `choice.id` in `sessionChoiceIds`: Apply opacity (grayed out).

#### Step 3.3: Companion Widget & Story Screen
**Prerequisites:** Step 3.2
*  Create `src/components/narrative/CompanionWidget.tsx`.
  *  Passive floating button.
  *  Icon: Specific to "The Elder" artifact.
  *  Clicking opens a simple Modal/Toast with `currentNode.companionHint`.
*  Create `src/components/narrative/StoryScreen.tsx`.
  *  Manages switching between `NarrativeView` (Book style) and `DialogueView` (Interaction style).

---

## Step 4: Content Integration

### Goal
Implement "The Spire of the Lich King" Act 1.

### Implementation Order

#### Step 4.1: Campaign Data
**Prerequisites:** Step 1
*  Create `src/data/campaigns/campaign-01.ts`.
*  **Key Scenes:**
  *  **Tavern (Rumors):** Dialogue with Poacher.
    *  *Check:* `[Intimidate DC 10] Tell me the truth!` (Reveals extra info).
  *  **Tower Entrance:** Puzzle Node.
    *  Narrative node describing the barrier.
    *  Companion Hint: "The stones... they hum when near the barrier. Look in the rubble."

---

## File Structure & Architecture

### New Files to Create

*  `src/types/narrative.ts` - Interfaces for Nodes, Choices, Logs.
*  `src/store/narrativeStore.ts` - State (Log, Flags, Current Node).
*  `src/utils/narrativeLogic.ts` - Dice rolling and requirements.
*  `src/components/narrative/NarrativeLog.tsx` - Scrollable history component.
*  `src/components/narrative/DialogueView.tsx` - NPC Interaction UI.
*  `src/components/narrative/CompanionWidget.tsx` - Passive hint button.
*  `src/data/campaigns/campaign-01.ts` - Act 1 Data.

### Architectural Principles

1. **Ephemeral Dialogue State:** The `sessionChoiceIds` array in the store ensures options are grayed out *while talking*, but cleared if the player leaves and returns (per user request).
2. **Unified Logging:** The `NarrativeLog` serves as both the "Speech Bubble" history and the "System Log" for dice rolls, keeping all context in one scrollable view.
3. **Passive Companion:** The Companion logic is strictly "Pull" (user clicks), never "Push" (auto-popup), ensuring it doesn't annoy the player.

---

## Testing Strategy

### Automated Unit Tests
*  **`narrativeLogic.test.ts`**:
  *  Mock a player with STR 14 (+2).
  *  Run `resolveSkillCheck` with DC 10.
  *  Verify logic correctly adds Modifier to Roll and compares to DC.
*  **`narrativeStore.test.ts`**:
  *  Test `handleChoice`: Verify it populates the Log and updates `sessionChoiceIds`.
  *  Test `resetSessionState`: Verify Log and IDs are cleared.

### Manual Verification
1. **Skill Check Visuals:**
  *  Trigger the Intimidate check with the Poacher.
  *  Verify the Log updates with: "Rolled X + Mod vs DC 10".
  *  Verify the correct success/fail node loads.
2. **Reset Behavior:**
  *  Ask the Poacher a question (it grays out).
  *  Leave conversation.
  *  Talk to Poacher again.
  *  Verify the question is **not** grayed out (Reset per interaction).