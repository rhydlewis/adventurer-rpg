# Phase 1: Core d20 Mechanics - Implementation Plan

**Date:** 2025-12-09
**Status:** Design Complete - Ready for Implementation
**Scope:** Implement all 4 character classes with distinct mechanics, spell system, and combat variety

---

## Overview

Phase 1 transforms the walking skeleton into a complete d20 combat system with full class differentiation. This phase is divided into three sequential steps:

1. **Step 1: Class Differentiation** - Make Fighter/Rogue/Wizard/Cleric feel distinctly different
2. **Step 2: Spell System** - Complete spell infrastructure for Wizard/Cleric
3. **Step 3: Combat Variety** - Multiple enemy types using different tactics and conditions

---

## Step 1: Class Differentiation

### Goal
Make all 4 classes playable with full level 1 features while keeping the existing walking skeleton intact.

### Implementation Order

#### Phase 1.1: Character Creation & Attributes
- Point buy system (27 points)
- Class selection with recommended arrays
- Skill rank allocation (choose trained skills)
- Fighter feat selection
- Equipment assignment (fixed per class)
- Display full character sheet

#### Phase 1.2: Enhanced Combat Foundation
- Initiative system (1d20 + DEX + mods, roll once per combat)
- Critical hits (double damage dice)
- Critical fumbles (miss + minor penalty)
- General saving throw system (Fort/Reflex/Will)
- Multiple action types (Attack, Cast Spell, Use Ability, Use Item)
- Action selection UI

#### Phase 1.3: Class-Specific Mechanics
- Fighter: Second Wind, Power Attack toggle, feat effects
- Rogue: Sneak Attack calculation, Dodge ability, Evasion
- Wizard: Cantrip system (at-will spells), spell slot tracking
- Cleric: Channel Energy, Turn Undead (vs undead enemies)
- Resource tracking UI (show uses remaining)

#### Phase 1.4: Conditions System
- Condition application/removal
- Duration tracking (countdown each turn)
- Condition effects on combat calculations
- Visual indicators (icons/text)
- Save-to-resist on application

#### Phase 1.5: Rest System
- Short rest: Restore encounter abilities (Second Wind, Dodge, etc.)
- Long rest: Restore everything (HP, spells, daily abilities)
- Rest UI screens

#### Phase 1.6: Mobile & Responsive Polish
- Mobile-first layout optimization for all screens
- Touch-friendly UI elements (larger tap targets, spacing)
- Font size scaling for readability on small screens
- Character sheet mobile layout (collapsible sections, tabs)
- Combat screen mobile optimization (action buttons, status display)
- Portrait orientation support (primary target)
- Landscape orientation adjustments (secondary)
- Test on multiple device sizes (320px, 375px, 768px, 1024px)
- Touch gesture support (tap, swipe for navigation where appropriate)
- Ensure all buttons meet 44px minimum touch target size

---

## Class Abilities - Level 1

### Fighter
- **HP:** 15 (10 base + 5 CON, buffed for solo play)
- **BAB:** +1
- **AC:** 18 (chainmail + shield)
- **Equipment:** Longsword (1d8+STR), Shield (+2 AC), Chainmail
- **Abilities:**
  - **Second Wind** (1/combat): Standard action, heal 1d10+1 HP
  - **Power Attack** (toggle): -2 attack rolls, +4 damage
  - **Combat Feat**: Choose one at creation
    - Weapon Focus: +1 to attack rolls
    - Toughness: +3 HP per level
    - Improved Initiative: +4 initiative
    - Combat Reflexes: +2 AC when using Dodge action
- **Saves:** Best Fort (+2)

### Rogue
- **HP:** 13 (8 base + 5 CON, buffed)
- **BAB:** +0
- **AC:** 15 (leather + DEX)
- **Equipment:** Rapier (1d6+DEX, finesse), Leather armor
- **Abilities:**
  - **Sneak Attack:** +1d6 damage when: (1) winning initiative, OR (2) enemy has condition
  - **Dodge** (1/combat): Standard action, +4 AC until your next turn
  - **Evasion** (passive): Reflex save success = zero damage (instead of half)
  - **Skill Expertise:** +4 Stealth, +4 to one chosen skill
- **Saves:** Best Reflex (+2)
- **Special:** Rapier uses DEX for attack and damage

### Wizard
- **HP:** 10 (6 base + 4 CON, buffed)
- **BAB:** +0
- **AC:** 12 (no armor + DEX)
- **Equipment:** Dagger (1d4+DEX, finesse), Arcane focus
- **Cantrips (at-will):**
  - Ray of Frost: 1d3 cold damage, ranged spell attack
  - Acid Splash: 1d3 acid damage, ranged spell attack
  - Daze: Will save or Stunned (1 turn), only works on enemies ≤5 HP
- **Spell Slots:** 2/day level-1 slots
- **Spells Known:**
  - Magic Missile: Auto-hit 1d4+1 force damage
  - Shield: +4 AC for 1 turn
  - Sleep: Will save or unconscious 1d4 turns (wake if damaged)
  - Burning Hands: 2d4 fire damage, Reflex save for half
- **Abilities:**
  - **Arcane Recovery** (1/combat): When enemy dies, regain 1 spell slot
- **Saves:** Best Will (+2)

### Cleric
- **HP:** 13 (8 base + 5 CON, buffed)
- **BAB:** +0
- **AC:** 18 (chainmail + shield)
- **Equipment:** Mace (1d6+STR), Shield (+2 AC), Chainmail, Holy symbol
- **Cantrips (at-will):**
  - Divine Favor: +1 to your next attack or save
  - Resistance: +1 to your next saving throw
  - Sacred Flame: 1d4 radiant damage, ranged spell attack (targets Will save)
- **Spell Slots:** 2/day level-1 slots
- **Spells Known:**
  - Cure Light Wounds: Heal 1d8+1 HP
  - Bless: +1 attack rolls for 3 turns (self)
  - Shield of Faith: +2 AC for 3 turns
  - Cause Fear: Will save or Frightened (flee/can't attack) 2 turns
- **Abilities:**
  - **Channel Energy** (2/day): Heal self 1d6 HP (free out of combat, standard in combat)
  - **Turn Undead** (3/day): Undead makes Will save (DC 11) or flees 1d4 turns
- **Saves:** Balanced (+1/+1/+1)

---

## Starting Attributes & Equipment

### Point Buy System
- 27-point buy standard (standard d20)
- Recommended arrays per class:
  - **Fighter:** STR 16, DEX 12, CON 14, INT 10, WIS 10, CHA 8
  - **Rogue:** STR 10, DEX 16, CON 12, INT 14, WIS 12, CHA 10
  - **Wizard:** STR 8, DEX 14, CON 12, INT 16, WIS 12, CHA 10
  - **Cleric:** STR 14, DEX 10, CON 14, INT 10, WIS 16, CHA 8

### Starting Equipment

| Class | Weapon | Damage | Armor | Shield | AC |
|-------|--------|--------|-------|--------|-----|
| Fighter | Longsword | 1d8+STR | Chainmail (16) | +2 | 18 |
| Rogue | Rapier | 1d6+DEX | Leather (12) | - | 15 |
| Wizard | Dagger | 1d4+DEX | None (10) | - | 12 |
| Cleric | Mace | 1d6+STR | Chainmail (16) | +2 | 18 |

### Starting Items (All Classes)
- 2 healing potions (2d8+2 HP each)
- **Rogue bonus:** 1 smoke bomb (auto-escape combat, 1 use)
- **Wizard bonus:** 2 arcane scrolls (extra spell casts)

---

## Skills System

### 6 Core Skills
1. **Athletics (STR)** - Class skill: Fighter
2. **Stealth (DEX)** - Class skill: Rogue
3. **Perception (WIS)** - Class skill: Rogue
4. **Arcana (INT)** - Class skill: Wizard
5. **Medicine (WIS)** - Class skill: Cleric
6. **Intimidate (CHA)** - Class skill: Fighter

### Mechanics
- **Roll:** 1d20 + Ability Mod + Ranks + Class Skill Bonus
- **Ranks:** 0-4 at level 1 (allocate during creation)
- **Class skill bonus:** +3 if trained (have ranks in it)
- **Rogue expertise:** Automatic +4 to Stealth + one chosen skill

### Usage in Step 1
- **Perception:** +2 initiative if Perception ≥ 3 ranks
- **Stealth:** +2 initiative if Stealth ≥ 5 total bonus
- **Others:** Affect story/skill checks (Phase 2+)

---

## Feat System

### Feat Progression (Levels 1-5)
- **Fighter:** Feats at levels 1, 2, 4 (3 total)
- **Other classes:** Feats at levels 3, 5 (2 total)

### Combat Feats (Fighter Level 1)
1. **Power Attack** - Toggle: -2 attack, +4 damage
2. **Weapon Focus** - +1 attack with chosen weapon
3. **Toughness** - +3 HP per level
4. **Improved Initiative** - +4 initiative
5. **Combat Reflexes** - +2 AC when using Dodge

### Future Feats (Levels 2-5)
- **Skill Feats:** Skill Focus (+3 one skill), Alertness (+2 Perception)
- **Magic Feats:** Spell Focus (+1 DC), Empower Spell (+50% damage 1/day)
- **General:** Iron Will (+2 Will), Lightning Reflexes (+2 Reflex)

---

## Action Economy

### Single Action Per Turn (Streamlined)
Each turn, choose ONE action:
- **Fighter:** Attack, Power Attack, Second Wind, Use Item
- **Rogue:** Attack, Sneak Attack (auto when conditions met), Dodge, Use Item
- **Wizard:** Attack (rarely), Cast Cantrip, Cast Spell, Use Item
- **Cleric:** Attack, Cast Cantrip, Cast Spell, Channel Energy, Use Item

**Move action:** Automatic/free (positioning doesn't matter in 1v1 combat)

---

## Saving Throws System

### Calculation
- **Fort Save:** Base (class) + CON modifier
- **Reflex Save:** Base (class) + DEX modifier
- **Will Save:** Base (class) + WIS modifier

### DC Calculation
- **Spell DC:** 10 + spell level + casting ability modifier
- **Example:** Wizard (INT 16, +3) casts Sleep (level 1): DC = 10 + 1 + 3 = 14

### Save Types
- **Negates:** Success = no effect (Sleep, Stun, Silence)
- **Half:** Success = half damage (Burning Hands)
- **Partial:** Success = reduced duration (Poison: 2→1 turns)

### Usage
1. Attacker sets DC
2. Defender rolls: 1d20 + save bonus vs DC
3. Apply result based on save type

---

## Combat Mechanics

### Initiative
- **Roll once at combat start:** 1d20 + DEX mod + bonuses
- **Bonuses:**
  - Improved Initiative feat: +4
  - Perception ≥3 ranks: +2
  - Stealth ≥5 total: +2
- **Highest goes first** (re-roll if tied)
- **Same turn order for entire combat**

### Critical Hits (Natural 20)
- Automatic hit regardless of AC
- **Roll damage dice twice, add modifiers once**
- Example: Longsword crit = 2d8+STR (not 1d8+STR)
- Sneak Attack doubles: 2d8+2d6+STR
- Spell damage doubles: Ray of Frost = 2d3
- Combat log: "CRITICAL HIT!" message

### Critical Fumbles (Natural 1)
- Automatic miss regardless of bonuses
- **Roll 1d4 for fumble effect:**
  1. **Drop weapon** - Lose next turn picking it up
  2. **Hit self** - Take 1d4 damage
  3. **Off-balance** - Enemy gets +2 AC until your next turn
  4. **Opening** - Enemy gets free attack immediately
- Combat log: "FUMBLE!" + effect description

---

## Conditions System

### 8 Conditions (5 Debuffs, 3 Buffs)

#### Debuffs
1. **Stunned** - Cannot take actions (1 turn)
2. **Poisoned** - 1d4 damage/turn, -2 attack rolls (fixed duration)
3. **Weakened** - -2 attack/damage (cast on enemies)
4. **Blinded** - -4 attack rolls, cannot cast targeted spells (fixed duration)
5. **Silenced** - Cannot cast spells (2 turns), can attack/use items

#### Buffs
1. **Strengthened** - +2 attack/damage (fixed duration)
2. **Enchanted** - +2 spell attack, +1 spell save DC (fixed duration)
3. **Shielded** - +4 AC (3 turns)

### Mechanics

#### Application
- Source: Spells, abilities, enemy attacks
- Resist: Some require save (1d20 + save vs DC)
- If failed/no save: Condition applies immediately

#### Duration Tracking
- Each condition has fixed duration (1-3 turns)
- Countdown at end of affected creature's turn
- Display: "[Poisoned: 2 turns]" under character HP

#### Stacking Rules
- **Multiple different conditions:** YES (Poisoned + Weakened)
- **Same condition multiple times:** NO (duration resets to highest)

#### Visual Display
- Condition icons/badges on character panel
- Tooltip: Effect description + turns remaining
- Color-coded: Red (debuff), Green (buff)

---

## Resource Management

### Encounter-Based (1/combat)
- Fighter: Second Wind
- Rogue: Dodge
- Wizard: Arcane Recovery

### Daily/Rest-Based
- Spell slots (Wizard/Cleric)
- Cleric: Channel Energy (2/day)
- Cleric: Turn Undead (3/day)

### At-Will (Unlimited)
- Cantrips
- Basic attacks
- Rogue: Sneak Attack (when conditions met)

### Rest System
- **Short Rest:** Restores encounter abilities only (Second Wind, Dodge, etc.)
- **Long Rest:** Restores everything (spell slots, daily abilities, HP)

---

## Step 2: Spell System

### Core Infrastructure
- Spell type definitions
- Spell slot tracking (per rest)
- Spell save DC calculation (10 + level + ability mod)
- Spell attack rolls (1d20 + BAB + ability mod)
- Spell targeting (self, single target, area)

### Wizard Spells

#### Cantrips (at-will)
- **Ray of Frost:** 1d3 cold damage, ranged spell attack
- **Acid Splash:** 1d3 acid damage, ranged spell attack
- **Daze:** Will save or Stunned (1 turn), only works on enemies ≤5 HP

#### Level 1 Spells (2 slots/day)
- **Magic Missile:** Auto-hit 1d4+1 force damage per missile (1 missile at level 1)
- **Shield:** +4 AC for 1 turn, immediate action
- **Sleep:** Will save or unconscious 1d4 turns (wake if damaged)
- **Burning Hands:** 2d4 fire damage, Reflex save for half

### Cleric Spells

#### Cantrips (at-will)
- **Divine Favor:** +1 to your next attack or save
- **Resistance:** +1 to your next saving throw
- **Sacred Flame:** 1d4 radiant damage, ranged spell attack (targets Will save)

#### Level 1 Spells (2 slots/day)
- **Cure Light Wounds:** Heal 1d8+1 HP
- **Bless:** +1 attack rolls for 3 turns (self)
- **Shield of Faith:** +2 AC for 3 turns
- **Cause Fear:** Will save or Frightened (flee/can't attack) 2 turns

### Spell Learning & Acquisition
- **Level 1:** Start with all listed spells known
- **Level 2+:** Learn 1 new spell per level (choose from expanded list)
- **Scrolls:** 1-time use consumable, any spell (find as loot)

---

## Step 3: Combat Variety

### Enemy Types (CR 1/4 to CR 2)

#### 1. Goblin (CR 1/4) - Tutorial Enemy
- **HP:** 8, **AC:** 15, **BAB:** +1
- **Attack:** Shortsword 1d4+1
- **Tactic:** Basic attacks only

#### 2. Skeleton (CR 1/3) - Undead
- **HP:** 10, **AC:** 13, **BAB:** +1
- **Attack:** Claw 1d4+1
- **Vulnerable:** Turn Undead, Sacred Flame (+50% damage)
- **Immune:** Poison, Sleep
- **Tests:** Turn Undead ability

#### 3. Corrupted Wolf (CR 1) - Fast Attacker
- **HP:** 15, **AC:** 14, **BAB:** +2
- **Attack:** Bite 1d6+2
- **Special:** High initiative (+4), chance to inflict Bleed (1 damage/turn, 3 turns)
- **Tests:** Initiative system, condition application

#### 4. Dark Cultist (CR 1) - Enemy Spellcaster
- **HP:** 12, **AC:** 12, **BAB:** +0
- **Attack:** Dagger 1d4
- **Spells:** Ray of Frost, Cause Fear, Magic Missile (2 slots)
- **Tactic:** Cast spells, retreats to Dagger if out of slots
- **Tests:** Enemy spellcasting, spell saves

#### 5. Venomous Spider (CR 1) - Status Applier
- **HP:** 14, **AC:** 16 (small, agile), **BAB:** +2
- **Attack:** Bite 1d4 + Fort save or Poisoned (1d4 damage/turn, -2 attacks, 3 turns)
- **Tactic:** Poison then retreat/defend
- **Tests:** Fortitude saves, Poison condition

#### 6. Wraith (CR 2) - Boss-Tier Undead
- **HP:** 25, **AC:** 15, **BAB:** +3
- **Attack:** Touch 1d6 + Weakened condition (no save, 2 turns)
- **Special:** Can cast Silence (2/combat), Turn Undead resistance (+4 Will save)
- **Tactic:** Silence casters, then attack with touch
- **Tests:** Advanced Turn Undead, Silence condition, multi-ability enemies

---

## File Structure & Architecture

### New Files to Create

```
src/
├── types/
│   ├── attributes.ts          [existing]
│   ├── character.ts            [EXTEND: add equipment, resources, conditions, skills, feats]
│   ├── combat.ts               [EXTEND: add initiative, conditions]
│   ├── dice.ts                 [existing]
│   ├── spell.ts                [NEW]
│   ├── condition.ts            [NEW]
│   ├── equipment.ts            [NEW]
│   ├── feat.ts                 [NEW]
│   ├── skill.ts                [NEW]
│   ├── resource.ts             [NEW]
│   └── enemy.ts                [NEW]
│
├── utils/
│   ├── dice.ts                 [existing]
│   ├── combat.ts               [EXTEND: add initiative, crits, fumbles]
│   ├── spellcasting.ts         [NEW]
│   ├── conditions.ts           [NEW]
│   ├── savingThrows.ts         [NEW]
│   ├── skills.ts               [NEW]
│   └── classAbilities.ts       [NEW]
│
├── data/
│   ├── classes.ts              [NEW: class definitions, progression]
│   ├── spells.ts               [NEW: spell library]
│   ├── feats.ts                [NEW: feat definitions]
│   ├── enemies.ts              [NEW: enemy templates]
│   └── equipment.ts            [NEW: weapon/armor stats]
│
├── stores/
│   ├── combatStore.ts          [EXTEND: add initiative, conditions, resources]
│   └── characterStore.ts       [NEW: character creation, progression]
│
└── screens/
    ├── CharacterCreationScreen.tsx  [NEW]
    ├── CombatScreen.tsx             [EXTEND: add action selection, conditions UI]
    ├── RestScreen.tsx               [NEW]
    └── CharacterSheetScreen.tsx     [NEW]
```

### Architectural Principles
1. **Separation of data and logic** - `/data` holds definitions, `/utils` has calculations
2. **Type safety** - All game entities have strict TypeScript types
3. **Store-based state** - Zustand stores manage game state
4. **Incremental extension** - Extend existing files rather than rewrite

---

## Testing Strategy

### Automated Unit Tests (Required for All Utils)

Write comprehensive unit tests for all `/utils` functions using Vitest. Tests must be written alongside implementation.

**Phase 1.1 - Character Creation Utils:**
- `src/__tests__/utils/pointBuy.test.ts`
  - Test point buy calculations (valid/invalid allocations)
  - Test attribute cost table (7-18 range)
  - Test remaining points calculation
- `src/__tests__/utils/characterCreation.test.ts`
  - Test character initialization from class + attributes
  - Test HP calculation (base + CON mod, buffed for solo)
  - Test AC calculation (armor + shield + DEX mod)
  - Test save calculations (base + ability mod)
- `src/__tests__/utils/skills.test.ts`
  - Test skill bonus calculation (ranks + ability mod + class bonus)
  - Test Rogue expertise (+4 automatic)
  - Test valid rank allocation (0-4 at level 1)
- `src/__tests__/utils/equipment.test.ts`
  - Test equipment assignment by class
  - Test weapon damage calculation
  - Test armor AC contributions

**Phase 1.2 - Combat Foundation Utils:**
- `src/__tests__/utils/initiative.test.ts`
  - Test initiative calculation (d20 + DEX + bonuses)
  - Test feat bonuses (Improved Initiative +4)
  - Test skill bonuses (Perception, Stealth)
- `src/__tests__/utils/criticals.test.ts`
  - Test critical hit detection (natural 20)
  - Test critical damage calculation (double dice, single modifier)
  - Test fumble detection (natural 1)
  - Test fumble effect determination (1d4)
- `src/__tests__/utils/savingThrows.test.ts`
  - Test save calculations (Fort/Reflex/Will)
  - Test save DC calculations (10 + level + mod)
  - Test save result types (negates, half, partial)

**Phase 1.3 - Class Abilities Utils:**
- `src/__tests__/utils/classAbilities.test.ts`
  - Fighter: Second Wind healing (1d10+1), Power Attack math (-2/+4)
  - Rogue: Sneak Attack conditions, Dodge AC bonus (+4)
  - Wizard: Spell slot management, Arcane Recovery
  - Cleric: Channel Energy healing (1d6), Turn Undead DC

**Phase 1.4 - Conditions Utils:**
- `src/__tests__/utils/conditions.test.ts`
  - Test condition application/removal
  - Test duration countdown
  - Test stacking rules (different vs same)
  - Test condition effects on stats (debuffs/buffs)

**Phase 1.5 - Rest Utils:**
- `src/__tests__/utils/rest.test.ts`
  - Test short rest restoration (encounter abilities only)
  - Test long rest restoration (everything)
  - Test resource tracking after rest

### Manual/Integration Tests

**After each phase implementation, manually verify:**

**Phase 1.1:**
- Character creation flow works in UI
- All 4 classes can be created with recommended arrays
- Fighter can select feat at creation
- Character sheet displays all stats correctly

**Phase 1.2:**
- Initiative rolls at combat start, determines turn order
- Critical hits show "CRITICAL HIT!" and deal double dice damage
- Fumbles show "FUMBLE!" with appropriate effect
- Action selection UI shows all available actions

**Phase 1.3:**
- Each class ability button appears and works
- Resource counters show uses remaining
- Abilities have correct effects in combat

**Phase 1.4:**
- Conditions appear as badges/icons on character panel
- Duration countdown works each turn
- Multiple conditions can be active simultaneously

**Phase 1.5:**
- Rest screens appear after combat
- Short rest restores only encounter abilities
- Long rest restores everything (HP, spells, daily abilities)

**Phase 1.6:**
- All screens display correctly on mobile devices (320px-768px width)
- Buttons are easily tappable (44px minimum touch target)
- Text is readable without zooming (minimum 16px base font)
- Character sheet doesn't require horizontal scrolling
- Combat UI fits on screen without excessive scrolling
- Touch interactions work smoothly (no accidental double-taps)
- Portrait and landscape orientations both functional

### Test Coverage Goal

- **Utils:** 100% coverage (all functions tested)
- **Stores:** Integration tested via manual testing
- **UI:** Manual testing for now (consider E2E tests in Phase 6)

---

## Success Criteria

Phase 1 is complete when:

- ✅ All 4 classes feel distinctly different in combat
- ✅ Each class has viable tactics and meaningful choices each turn
- ✅ Combat is more dynamic than "click Attack repeatedly"
- ✅ Spellcasters manage resources strategically
- ✅ Conditions create tactical depth
- ✅ Enemy variety forces different strategies per class
- ✅ Initiative, crits, fumbles, saves all work correctly
- ✅ Rest system properly restores resources
- ✅ Character creation is intuitive and produces valid characters
- ✅ All 6 enemy types present unique challenges
- ✅ All screens are fully responsive and mobile-friendly (320px-1024px)

---

## Next Steps

1. **Begin implementation** starting with Phase 1.1 (Character Creation)
2. **Test incrementally** after each phase
3. **Iterate on balance** based on playtesting
4. **Document issues** and edge cases discovered during implementation

Once Phase 1 is complete, we'll move to **Phase 2: Narrative System** (story nodes, campaign progression, world map).
